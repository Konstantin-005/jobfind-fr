name: Deploy to VPS (e77.top)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        env:
          NEXT_PUBLIC_WS_BASE_URL: wss://e77.top
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next public next.config.js package.json package-lock.json deploy/
          tar -czf jobfind-fr-${{ github.sha }}.tar.gz -C deploy .

      - name: Upload to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "jobfind-fr-${{ github.sha }}.tar.gz"
          target: "/tmp"

      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            APP_NAME="e77-top"
            DEPLOY_DIR="/www/wwwroot/e77.top"
            ARCHIVE_NAME="jobfind-fr-${{ github.sha }}.tar.gz"

            # Ensure directory exists
            mkdir -p "$DEPLOY_DIR"
            
            # Ensure uploads directories exist (preserve them)
            echo "Ensuring uploads directories exist"
            mkdir -p "$DEPLOY_DIR/public/uploads/companyLogo"

            # Clean old files but preserve uploads and node_modules if possible (for speed)
            # But for clean install, we remove node_modules. We MUST preserve public/uploads.
            # Using rsync logic or just careful removal could be better, but tar overwrite is usually fine.
            # Let's trust tar overwrite, but we might want to clear old .next folder to be sure.
            rm -rf "$DEPLOY_DIR/.next"

            # Extract new release (will overwrite existing files)
            echo "Extracting new release to $DEPLOY_DIR"
            tar -xzf "/tmp/${ARCHIVE_NAME}" -C "$DEPLOY_DIR"

            cd "$DEPLOY_DIR"

            # Ensure pm2 installed
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "Installing pm2 globally"
              npm i -g pm2
            fi

            # Install production dependencies
            echo "Installing production dependencies"
            # Remove old node_modules to ensure clean slate if needed, or just ci
            # npm ci is good.
            npm ci --omit=dev

            # Start or restart the application from correct directory
            echo "Starting or restarting the application from $DEPLOY_DIR"
            
            # Reload logic: delete old process to ensure new CWD and ENV are picked up
            pm2 delete "$APP_NAME" || true
            pm2 start npm --name "$APP_NAME" --cwd "$DEPLOY_DIR" -- start -- -p 4000

            # Save PM2 process list
            pm2 save

            # Clear nginx proxy cache to avoid stale HTML and reload nginx
            CACHE_DIR="/www/server/nginx/proxy_cache_dir"
            if [ -d "$CACHE_DIR" ]; then
              echo "Clearing nginx proxy cache in $CACHE_DIR"
              rm -rf "$CACHE_DIR"/* || true
            fi

            if [ -x "/www/server/nginx/sbin/nginx" ]; then
              echo "Reloading nginx"
              /www/server/nginx/sbin/nginx -s reload || true
            fi

            # Check application status
            echo "Checking application status"
            if ! pm2 describe "$APP_NAME" | grep -qi 'status.*online'; then
              echo "Error: Application failed to start"
              pm2 logs "$APP_NAME" --lines 200 || true
              exit 1
            fi

            # Cleanup
            echo "Cleaning up temporary files"
            rm -f "/tmp/${ARCHIVE_NAME}"

            echo "Deployment completed successfully!"
